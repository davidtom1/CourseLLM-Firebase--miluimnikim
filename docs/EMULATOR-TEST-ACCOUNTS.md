# Firebase Emulator Test Accounts

## Overview

Your app now uses Firebase Auth emulator with real authentication tokens that work across all Firebase services (Auth, Firestore, DataConnect).

## Test Accounts

### Student Account
- **Email**: `student@test.com`
- **Password**: `password123`
- **Role**: Student
- **UID**: Auto-generated by Auth emulator

### Teacher Account
- **Email**: `teacher@test.com`
- **Password**: `password123`
- **Role**: Teacher
- **UID**: Auto-generated by Auth emulator

## Starting the Emulators

```bash
# Start all required emulators
firebase emulators:start --only auth,firestore,dataconnect
```

This starts:
- **Auth Emulator**: `localhost:9099`
- **Firestore Emulator**: `localhost:8080`
- **DataConnect Emulator**: `localhost:9400`
- **Emulator UI**: `http://localhost:4000`

## Seeding Test Users

The test users need to be created each time you restart the emulators (Auth emulator data is not persisted):

```bash
node scripts/seed-test-users.js
```

This creates both test accounts in the Auth emulator and their profiles in Firestore.

## Using Test Accounts

1. Start the emulators
2. Seed the test users
3. Start your Next.js dev server: `npm run dev`
4. Go to the login page
5. Click "Mock Student" or "Mock Teacher" buttons

The app will:
- Sign in using the Auth emulator
- Get a real Firebase auth token
- Create/update the user profile in Firestore
- Redirect to the appropriate dashboard

## How It Works

### Authentication Flow

1. Click "Mock Student" or "Mock Teacher"
2. App calls `signInWithEmailAndPassword()` with test credentials
3. Auth emulator validates and returns auth token
4. App creates/updates Firestore profile with role and user data
5. AuthProviderClient manages auth state globally
6. All Firebase services (Firestore, DataConnect) receive valid auth tokens

### DataConnect Authorization

DataConnect queries already use `@auth(level: PUBLIC)` in your GraphQL operations, so they don't enforce authentication. However, having real auth tokens means:
- You can add proper authorization rules later
- User IDs are real and consistent
- Auth state is properly tracked

### Benefits Over Mock Auth

1. **Real Firebase Auth**: Uses actual Firebase SDK, not localStorage hacks
2. **Proper Auth Tokens**: All emulators receive valid auth tokens
3. **Works with DataConnect**: No more authorization bypass needed
4. **Easy to Switch**: Just change `NEXT_PUBLIC_FIREBASE_USE_EMULATOR=false` to use production
5. **Realistic Testing**: Emulator behavior matches production Firebase

## Configuration

See [.env.local](.env.local):
- `NEXT_PUBLIC_FIREBASE_USE_EMULATOR=true` - Enable emulator connection
- Auth emulator connects automatically when enabled
- Firestore emulator connects automatically when enabled

## Troubleshooting

### "User not found" error
- Make sure you ran `node scripts/seed-test-users.js` after starting emulators
- Check that emulators are running on correct ports

### "Permission denied" in Firestore
- Check [firestore.rules](../firestore.rules) - should allow all reads/writes for development
- Verify emulator is connected in browser console

### DataConnect errors
- Ensure DataConnect emulator is running (check Emulator UI)
- Verify port 9400 is not in use by another process
- Check that `pgliteData` directory was created successfully
